{% extends "store/base_shop.html" %}

{% block content %}
<div class="container my-4">
  <h3 class="mb-4">Chọn địa chỉ nhận hàng</h3>

  {% if messages %}
  <div>
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <form method="post" action="{% url 'checkout_address' %}" class="needs-validation" novalidate>
    {% csrf_token %}
    <input type="hidden" name="itemSelected" value="{{ itemIds }}">

    {% if contacts %}
    <div class="card mb-4 p-3 shadow-sm">
      <p class="fw-semibold mb-3">Chọn địa chỉ có sẵn:</p>
      <div class="row row-cols-1 row-cols-md-2 g-3">
        {% for c in contacts %}
        <div class="col">
          <div class="form-check border rounded p-3 h-100">
            <input class="form-check-input" type="radio" name="selected_contact" id="contact-{{ c.id }}" value="{{ c.id }}">
            <label class="form-check-label d-block" for="contact-{{ c.id }}">
              <strong>Địa chỉ:</strong> {{ c.address }}<br>
              <strong>Điện thoại:</strong> {{ c.contact_phone }}<br>
              <strong>Email:</strong> {{ c.contact_email|default:"Chưa có" }}
            </label>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <hr class="my-4">
    <p class="fw-semibold mb-3">Hoặc nhập địa chỉ mới:</p>
    {% else %}
    <div class="alert alert-info" role="alert">
      Bạn chưa có địa chỉ nhận hàng nào. Vui lòng nhập địa chỉ mới:
    </div>
    {% endif %}

    <div class="card p-4 shadow-sm mb-4">
      <div class="mb-3">
        <label for="new_address" class="form-label fw-semibold">Địa chỉ nhận hàng</label>
        <textarea name="new_address" id="new_address" rows="3" class="form-control"></textarea>
        <div class="invalid-feedback">
          Vui lòng nhập địa chỉ nhận hàng.
        </div>
      </div>

      <div class="mb-3">
        <label for="new_phone" class="form-label fw-semibold">Số điện thoại liên hệ</label>
        <input type="text" name="new_phone" id="new_phone" class="form-control" />
        <div class="invalid-feedback">
          Vui lòng nhập số điện thoại liên hệ.
        </div>
      </div>

      <div class="mb-3">
        <label for="new_email" class="form-label fw-semibold">Email liên hệ (không bắt buộc)</label>
        <input type="email" name="new_email" id="new_email" class="form-control" placeholder="example@domain.com" />
      </div>
    </div>

    <div class="mb-4">
      <label for="voucher_code" class="form-label fw-semibold">Mã voucher (nếu có)</label>
      <input type="text" name="voucher_code" id="voucher_code" class="form-control" placeholder="Nhập mã voucher" />
    </div>

    <div class="d-flex gap-3">
      <button type="submit" name="action" value="add_address" class="btn btn-outline-primary flex-grow-1">
        <i class="fa fa-plus me-2"></i> Thêm địa chỉ mới
      </button>

      <button type="submit" name="action" value="checkout" class="btn btn-warning flex-grow-1">
        <i class="fa fa-credit-card me-2"></i> Tiếp tục thanh toán
      </button>
    </div>
  </form>
</div>

<script>
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      const addAddressBtn = event.submitter;
      if (addAddressBtn && addAddressBtn.value === 'add_address') {
        if (!form.new_address.value.trim() || !form.new_phone.value.trim()) {
          event.preventDefault();
          event.stopPropagation();
          if (!form.new_address.value.trim()) form.new_address.classList.add('is-invalid');
          if (!form.new_phone.value.trim()) form.new_phone.classList.add('is-invalid');
          return;
        }
      }
      if (addAddressBtn && addAddressBtn.value === 'checkout') {
        const selectedContact = form.querySelector('input[name="selected_contact"]:checked');
        if (!selectedContact && !form.new_address.value.trim()) {
          event.preventDefault();
          event.stopPropagation();
          alert('Vui lòng chọn hoặc nhập địa chỉ nhận hàng trước khi thanh toán.');
          return;
        }
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>
{% endblock %}
